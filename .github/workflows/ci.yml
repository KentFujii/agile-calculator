name: Create PR with Gemini

on:
  pull_request:
    branches:
    - main

jobs:
  create-pr:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # - uses: mxschmitt/action-tmate@v3
      - name: Build
        run: |
          echo -n "GITHUB_CLASSIC_TOKEN=${GITHUB_TOKEN}" > .env
          docker compose build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Test
        run: |
          docker compose run --rm jupyter uv run pytest
      - name: Lint
        run: |
          docker compose run --rm jupyter uv run ruff check --fix
      - name: Typecheck
        run: |
          docker compose run --rm jupyter uv run ty check
      - name: E2E
        run: |
          docker compose run --rm jupyter agile-calculator \
            --log_level=DEBUG \
            pull_requests \
            KentFujii/agile-calculator \
            "" \
            90 \
            cycle_time \
            matplotlib
